name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Get version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$TAG" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # ============================================
      # Build Plugin (Frontend)
      # ============================================
      - name: Build Plugin
        run: |
          dotnet build Jellyfin.Plugin.Hanimeta/Jellyfin.Plugin.Hanimeta.csproj \
            -c Release \
            -p:Version=${{ steps.version.outputs.VERSION }}

      - name: Package Plugin
        run: |
          cd Jellyfin.Plugin.Hanimeta/bin/Release/net9.0
          zip -r ../../../../jellyfin-plugin-hanimeta-${{ steps.version.outputs.VERSION }}.zip Jellyfin.Plugin.Hanimeta.dll

      # ============================================
      # Build Backend - Windows
      # ============================================
      - name: Build Backend - Windows x64
        run: |
          dotnet publish ScraperBackendService/ScraperBackendService.csproj \
            -c Release \
            -r win-x64 \
            --self-contained true \
            -p:Version=${{ steps.version.outputs.VERSION }} \
            -p:PublishSingleFile=false \
            -p:PublishTrimmed=false \
            -o ./publish/backend-windows-x64

      - name: Add Playwright Scripts - Windows
        run: |
          cd publish/backend-windows-x64
          
          cat > install-playwright.bat << 'EOFBAT'
          @echo off
          echo.
          echo ================================================
          echo   Hanimeta Backend - Playwright Installation
          echo ================================================
          echo.
          echo Installing Playwright Chromium browser...
          echo.
          pwsh playwright.ps1 install chromium
          echo.
          echo ================================================
          echo   Installation Complete!
          echo ================================================
          echo.
          pause
          EOFBAT
          
          cat > install-playwright.ps1 << 'EOFPS1'
          #!/usr/bin/env pwsh
          Write-Host ""
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "  Hanimeta Backend - Playwright Installation" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Installing Playwright Chromium browser..." -ForegroundColor Yellow
          
          & "$PSScriptRoot\playwright.ps1" install chromium
          
          Write-Host ""
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "  Installation Complete!" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Green
          Write-Host ""
          EOFPS1
          
          cat > README.txt << 'EOFREADME'
          Hanimeta Backend Service - Windows
          ===================================
          
          Installation:
          1. Run install-playwright.bat to install browser dependencies
          2. Start ScraperBackendService.exe
          3. Service will run on http://localhost:5000
          
          Configuration:
          - Edit appsettings.json to customize settings
          - Default port: 5000
          
          Requirements:
          - PowerShell 7+ (for Playwright installation)
          - .NET 9.0 Runtime (included in this self-contained build)
          EOFREADME
          
          zip -r ../../hanimeta-backend-windows-x64-${{ steps.version.outputs.VERSION }}.zip .

      # ============================================
      # Build Backend - Linux
      # ============================================
      - name: Build Backend - Linux x64
        run: |
          dotnet publish ScraperBackendService/ScraperBackendService.csproj \
            -c Release \
            -r linux-x64 \
            --self-contained true \
            -p:Version=${{ steps.version.outputs.VERSION }} \
            -p:PublishSingleFile=false \
            -p:PublishTrimmed=false \
            -o ./publish/backend-linux-x64

      - name: Add Playwright Scripts - Linux
        run: |
          cd publish/backend-linux-x64
          
          cat > install-playwright.sh << 'EOFSH'
          #!/bin/bash
          echo ""
          echo "================================================"
          echo "  Hanimeta Backend - Playwright Installation"
          echo "================================================"
          echo ""
          echo "Installing Playwright Chromium browser..."
          echo ""
          
          pwsh playwright.ps1 install chromium
          
          echo ""
          echo "================================================"
          echo "  Installation Complete!"
          echo "================================================"
          echo ""
          EOFSH
          
          chmod +x install-playwright.sh
          
          cat > hanimeta-backend.service << 'EOFSVC'
          [Unit]
          Description=Hanimeta Scraper Backend Service
          After=network.target
          
          [Service]
          Type=simple
          User=jellyfin
          Group=jellyfin
          WorkingDirectory=/opt/hanimeta-backend
          ExecStart=/opt/hanimeta-backend/ScraperBackendService
          Restart=on-failure
          RestartSec=10
          
          # Security settings
          NoNewPrivileges=true
          PrivateTmp=true
          
          [Install]
          WantedBy=multi-user.target
          EOFSVC
          
          cat > README.txt << 'EOFREADME'
          Hanimeta Backend Service - Linux
          =================================
          
          Quick Start:
          1. Extract: tar -xzf hanimeta-backend-linux-x64-*.tar.gz -C /opt/hanimeta-backend
          2. Install Playwright: cd /opt/hanimeta-backend && ./install-playwright.sh
          3. Run: ./ScraperBackendService
          
          Install as systemd service:
          1. sudo cp hanimeta-backend.service /etc/systemd/system/
          2. sudo systemctl daemon-reload
          3. sudo systemctl enable hanimeta-backend
          4. sudo systemctl start hanimeta-backend
          5. sudo systemctl status hanimeta-backend
          
          Configuration:
          - Edit appsettings.json to customize settings
          - Default port: 5000
          
          Requirements:
          - PowerShell 7+ (for Playwright installation)
          - .NET 9.0 Runtime (included in this self-contained build)
          EOFREADME
          
          tar -czf ../../hanimeta-backend-linux-x64-${{ steps.version.outputs.VERSION }}.tar.gz .

      # ============================================
      # Create Release
      # ============================================
      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.TAG }}
          draft: true
          prerelease: false
          body: |
            ## 🎉 Hanimeta Release ${{ steps.version.outputs.TAG }}
            
            ### 📦 Downloads
            
            | Package | Description | File |
            |---------|-------------|------|
            | 🔌 **Plugin** | Jellyfin frontend plugin | `jellyfin-plugin-hanimeta-${{ steps.version.outputs.VERSION }}.zip` |
            | 🪟 **Backend (Windows)** | Backend service for Windows | `hanimeta-backend-windows-x64-${{ steps.version.outputs.VERSION }}.zip` |
            | 🐧 **Backend (Linux)** | Backend service for Linux | `hanimeta-backend-linux-x64-${{ steps.version.outputs.VERSION }}.tar.gz` |
            
            ---
            
            ### 📝 Release Notes
            
            <!-- 
            ╔════════════════════════════════════════════════════════════╗
            ║  ✏️  EDIT THIS SECTION BEFORE PUBLISHING THE RELEASE  ✏️  ║
            ╚════════════════════════════════════════════════════════════╝
            
            Add your release notes here. Example format:
            
            #### ✨ What's New
            - Added new feature X
            - Improved performance of Y
            
            #### 🐛 Bug Fixes
            - Fixed issue with Z
            - Resolved problem with W
            
            #### ⚠️ Breaking Changes
            - Changed configuration format (migration guide below)
            
            #### 📚 Documentation
            - Updated installation guide
            - Added troubleshooting section
            
            -->
            
            **TODO: Add your release notes above this line**
            
            ---
            
            ### 🚀 Installation
            
            #### Plugin Installation
            1. Download `jellyfin-plugin-hanimeta-${{ steps.version.outputs.VERSION }}.zip`
            2. Extract the DLL to your Jellyfin plugins directory:
               - Windows: `C:\ProgramData\Jellyfin\Server\plugins\Hanimeta\`
               - Linux: `/var/lib/jellyfin/plugins/Hanimeta/`
            3. Restart Jellyfin
            4. Configure plugin in Jellyfin Dashboard → Plugins → Hanimeta
            
            #### Backend Installation
            
            **Windows:**
            ```powershell
            # Extract the archive
            Expand-Archive hanimeta-backend-windows-x64-${{ steps.version.outputs.VERSION }}.zip -DestinationPath C:\hanimeta-backend
            
            # Install Playwright browsers
            cd C:\hanimeta-backend
            .\install-playwright.bat
            
            # Start the service
            .\ScraperBackendService.exe
            ```
            
            **Linux:**
            ```bash
            # Extract
            sudo mkdir -p /opt/hanimeta-backend
            sudo tar -xzf hanimeta-backend-linux-x64-${{ steps.version.outputs.VERSION }}.tar.gz -C /opt/hanimeta-backend
            
            # Install Playwright browsers
            cd /opt/hanimeta-backend
            sudo ./install-playwright.sh
            
            # Option 1: Run directly
            ./ScraperBackendService
            
            # Option 2: Install as systemd service
            sudo cp hanimeta-backend.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable hanimeta-backend
            sudo systemctl start hanimeta-backend
            sudo systemctl status hanimeta-backend
            ```
            
            ### 📋 Requirements
            
            - **Jellyfin**: 10.10.x or later
            - **.NET Runtime**: 9.0 (included in self-contained backend builds)
            - **PowerShell**: 7.0+ (for Playwright installation)
            - **Operating System**:
              - Windows: Windows 10/11 or Windows Server 2019+
              - Linux: Ubuntu 20.04+, Debian 11+, or equivalent
            
            ### ⚙️ Configuration
            
            **Plugin Configuration** (Jellyfin Dashboard):
            - Backend API URL (default: `http://localhost:5000`)
            - Request timeout settings
            - Provider-specific settings
            
            **Backend Configuration** (`appsettings.json`):
            - Server port (default: 5000)
            - Rate limiting settings
            - Cache configuration
            - Playwright browser settings
            
            ### 🔧 Troubleshooting
            
            **Plugin can't connect to backend:**
            - Ensure backend service is running
            - Check backend URL in plugin configuration
            - Verify firewall settings allow connections to port 5000
            
            **Playwright browser errors:**
            - Run the install-playwright script again
            - Check PowerShell 7+ is installed
            - Ensure sufficient disk space for browser downloads
            
            **Performance issues:**
            - Adjust rate limiting settings in appsettings.json
            - Increase cache size if needed
            - Check system resources (CPU, memory)
            
            ### 📚 Documentation
            
            - [Full Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [Configuration Guide](https://github.com/${{ github.repository }}/blob/main/docs/configuration.md)
            - [Troubleshooting](https://github.com/${{ github.repository }}/blob/main/docs/troubleshooting.md)
            
            ---
            
            ### 📝 Post-Release Steps
            
            **After publishing this release**, update the manifest with release information:
            
            ```bash
            pwsh scripts/update-manifest-from-release.ps1 -ReleaseTag ${{ steps.version.outputs.TAG }}
            ```
            
            This will:
            - Download the plugin package from GitHub
            - Calculate the checksum
            - Update manifest.json with version, timestamp, and checksum
            - Add this version to the version history (preserving old versions)
            
            Then commit and push the updated manifest:
            ```bash
            git add Jellyfin.Plugin.Hanimeta/manifest.json
            git commit -m "Update manifest for release ${{ steps.version.outputs.TAG }} [skip ci]"
            git push
            ```
            
            ---
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/...
          files: |
            jellyfin-plugin-hanimeta-${{ steps.version.outputs.VERSION }}.zip
            hanimeta-backend-windows-x64-${{ steps.version.outputs.VERSION }}.zip
            hanimeta-backend-linux-x64-${{ steps.version.outputs.VERSION }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "✅ Release draft created successfully!"
          echo ""
          echo "📋 Next Steps:"
          echo "1. Go to https://github.com/${{ github.repository }}/releases"
          echo "2. Find the draft release for ${{ steps.version.outputs.TAG }}"
          echo "3. Edit and add your release notes in the marked section"
          echo "4. Click 'Publish release'"
          echo ""
          echo "5. After publishing, run the manifest update script:"
          echo "   pwsh scripts/update-manifest-from-release.ps1 -ReleaseTag ${{ steps.version.outputs.TAG }}"
          echo ""
          echo "📦 Artifacts created:"
          echo "   - jellyfin-plugin-hanimeta-${{ steps.version.outputs.VERSION }}.zip"
          echo "   - hanimeta-backend-windows-x64-${{ steps.version.outputs.VERSION }}.zip"
          echo "   - hanimeta-backend-linux-x64-${{ steps.version.outputs.VERSION }}.tar.gz"
