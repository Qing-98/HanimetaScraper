# ScraperBackendServiceHanimetaScraper 的核心后端服务，提供 REST API 用于元数据刮削。## 功能特性- **多提供商支持** - Hanime、DLsite- **RESTful API** - 标准化 JSON 响应- **反机器人保护** - Playwright 浏览器自动化- **并发控制** - 可配置的 Provider 访问限制- **缓存机制** - 内存缓存减少重复请求- **身份验证** - 可选 API Token 认证## API 端点### 基础- `GET /` - 服务信息- `GET /health` - 健康检查- `GET /cache/stats` - 缓存统计- `DELETE /cache/clear` - 清空缓存- `DELETE /cache/{provider}/{id}` - 删除特定缓存### Hanime- `GET /api/hanime/search?title={query}&max={limit}` - 搜索- `GET /api/hanime/{id}` - 获取详情### DLsite  - `GET /api/dlsite/search?title={query}&max={limit}` - 搜索- `GET /api/dlsite/{id}` - 获取详情## 配置### 主要配置项（appsettings.json）```json{  "ServiceConfig": {    "Port": 8585,    "Host": "0.0.0.0",    "AuthToken": "",    "TokenHeaderName": "X-API-Token",    "HanimeMaxConcurrentRequests": 3,    "DlsiteMaxConcurrentRequests": 3,    "RequestTimeoutSeconds": 150,    "EnableAggressiveMemoryOptimization": true  }}```### 配置选项详解| 配置项 | 描述 | 默认值 | 推荐范围 ||--------|------|--------|----------|| **Port** | HTTP 监听端口 | 8585 | 1024-65535 || **Host** | 监听地址 | "0.0.0.0" | "127.0.0.1"（本地）/"0.0.0.0"（所有接口） || **AuthToken** | API 认证令牌 | 空字符串 | 强随机字符串（生产环境必须设置） || **TokenHeaderName** | 认证头名称 | "X-API-Token" | 自定义头名称 || **HanimeMaxConcurrentRequests** | Hanime 并发限制 | 3 | 1-15 || **DlsiteMaxConcurrentRequests** | DLsite 并发限制 | 3 | 1-15 || **RequestTimeoutSeconds** | 请求超时时间（秒） | 150 | 60-300 || **EnableAggressiveMemoryOptimization** | 启用激进内存优化 | true | true/false || **HanimeRateLimitSeconds** | Hanime 速率限制间隔（秒） | 30 | 0-120 || **DlsiteRateLimitSeconds** | DLsite 速率限制间隔（秒） | 30 | 0-120 |### 并发控制说明**Provider 并发限制** - 统一控制对各提供商网站的访问：- `HanimeMaxConcurrentRequests` - 限制对 Hanime 网站的同时访问数- `DlsiteMaxConcurrentRequests` - 限制对 DLsite 网站的同时访问数- 包括搜索请求、详情获取、直接 ID 查询等所有操作### 速率限制说明**每槽独立速率限制** - 为每个并发槽提供独立的速率控制：- `HanimeRateLimitSeconds` - 每个 Hanime 并发槽在缓存未命中时的最小请求间隔- `DlsiteRateLimitSeconds` - 每个 DLsite 并发槽在缓存未命中时的最小请求间隔- 缓存命中时不受速率限制影响,立即返回结果- 设置为 0 可禁用速率限制- 每个槽有自己的独立计时器,不同槽之间互不影响**速率限制工作原理：**1. 请求到达 → 检查缓存2. 缓存命中 → 立即返回（无速率限制）✅3. 缓存未命中 → 获取并发槽4. 槽获取成功 → 检查该槽的最后请求时间5. 如需等待 → 等待直到满足速率限制间隔6. 从提供商获取数据 → 缓存并返回### 环境变量覆盖以下环境变量可覆盖配置文件设置：| 环境变量 | 对应配置 | 示例 ||----------|----------|------|| **SCRAPER_PORT** | Port | `8080` || **SCRAPER_AUTH_TOKEN** | AuthToken | `your-secret-token-here` |### 缓存配置缓存系统自动配置，主要参数：- **缓存容量**：100 个条目- **成功结果 TTL**：2 分钟- **失败结果 TTL**：2 分钟- **驱逐策略**：LRU（最近最少使用）**提示：** 提高缓存命中率可以显著提升响应速度,因为缓存命中时完全绕过速率限制。### 性能调优建议**低负载环境（个人使用）：**```json{  "HanimeMaxConcurrentRequests": 3,  "DlsiteMaxConcurrentRequests": 3,  "HanimeRateLimitSeconds": 20,  "DlsiteRateLimitSeconds": 20}```**高负载环境（多用户）：**```json{  "HanimeMaxConcurrentRequests": 10,  "DlsiteMaxConcurrentRequests": 10,  "HanimeRateLimitSeconds": 20,  "DlsiteRateLimitSeconds": 20}```**保守设置（避免被封）：**```json{  "HanimeMaxConcurrentRequests": 1,  "DlsiteMaxConcurrentRequests": 1,  "HanimeRateLimitSeconds": 60,  "DlsiteRateLimitSeconds": 60}```**禁用速率限制（仅依赖并发控制）：**```json{  "HanimeMaxConcurrentRequests": 3,  "DlsiteMaxConcurrentRequests": 3,  "HanimeRateLimitSeconds": 0,  "DlsiteRateLimitSeconds": 0}```## 技术栈- **.NET 8** - 现代 C# Runtime- **ASP.NET Core** - Web API 框架- **Playwright** - 浏览器自动化- **HtmlAgilityPack** - HTML 解析