# ScraperBackendService> **[English](README.en.md) | ä¸­æ–‡**HanimetaScraper çš„æ ¸å¿ƒåç«¯æœåŠ¡ï¼Œä¸º Hanime å’Œ DLsite å†…å®¹æä¾› REST APIï¼Œå…·å¤‡**é«˜çº§é€Ÿç‡é™åˆ¶å’Œåæ£€æµ‹åŠŸèƒ½**ã€‚## åŠŸèƒ½ç‰¹æ€§### æ ¸å¿ƒèƒ½åŠ›- **å¤šæä¾›å•†æ”¯æŒ** - Hanimeã€DLsiteï¼Œç»Ÿä¸€æ¥å£- **RESTful API** - æ ‡å‡†åŒ– JSON å“åº”- **åæœºå™¨äººä¿æŠ¤** - Playwright æµè§ˆå™¨è‡ªåŠ¨åŒ–ä¸éšèº«æ¨¡å¼- **æ™ºèƒ½ç¼“å­˜** - å†…å­˜ç¼“å­˜é…åˆ LRU æ·˜æ±°ç­–ç•¥ï¼Œå‡å°‘é‡å¤è¯·æ±‚- **èº«ä»½éªŒè¯** - å¯é€‰ API Token è®¤è¯ï¼Œç”¨äºå®‰å…¨éƒ¨ç½²### é«˜çº§é€Ÿç‡é™åˆ¶- **å¹¶å‘æ§åˆ¶** - å¯é…ç½®çš„æä¾›å•†è®¿é—®é™åˆ¶ï¼ˆé»˜è®¤ï¼š3ä¸ªæ§½ä½ï¼‰- **æ¯æ§½é€Ÿç‡é™åˆ¶** - å¼ºåˆ¶è¿ç»­è¯·æ±‚çš„æœ€å°é—´éš”ï¼ˆé»˜è®¤ï¼š30ç§’ï¼‰- **è¯·æ±‚é˜Ÿåˆ—** - æœ€å¤šç­‰å¾…15ç§’è·å–å¯ç”¨æ§½ä½ï¼Œè€Œéç«‹å³æ‹’ç»- **æ™ºèƒ½èŠ‚æµ** - é˜²æ­¢IPå°ç¦çš„åŒæ—¶æœ€å¤§åŒ–ååé‡### æ€§èƒ½ä¼˜åŒ–- **æ¿€è¿›å†…å­˜ç®¡ç†** - å¯é€‰çš„GCä¼˜åŒ–ï¼Œé€‚ç”¨äºä½å†…å­˜ç¯å¢ƒ- **æ‰©å±•è¶…æ—¶** - 150ç§’åç«¯è¶…æ—¶ + 180ç§’å‰ç«¯è¶…æ—¶ï¼Œç¡®ä¿å®Œæ•´è¯·æ±‚æµç¨‹- **ç¼“å­˜ç»Ÿè®¡** - ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œæ€§èƒ½æŒ‡æ ‡- **ç»“æ„åŒ–æ—¥å¿—** - å¤šçº§è¯¦ç»†åº¦ï¼Œç”¨äºè°ƒè¯•å’Œç›‘æ§## API ç«¯ç‚¹### åŸºç¡€ç«¯ç‚¹- `GET /` - æœåŠ¡ä¿¡æ¯å’Œè®¤è¯çŠ¶æ€- `GET /health` - å¥åº·æ£€æŸ¥ç«¯ç‚¹- `GET /cache/stats` - ç¼“å­˜ç»Ÿè®¡ï¼ˆå‘½ä¸­ç‡ã€é©±é€æ¬¡æ•°ç­‰ï¼‰- `DELETE /cache/clear` - æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ¡ç›®- `DELETE /cache/{provider}/{id}` - åˆ é™¤ç‰¹å®šç¼“å­˜æ¡ç›®### Hanime ç«¯ç‚¹- `GET /api/hanime/search?title={query}&max={limit}` - æŒ‰æ ‡é¢˜æœç´¢ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰- `GET /api/hanime/{id}` - æŒ‰IDè·å–è¯¦æƒ…ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰### DLsite ç«¯ç‚¹- `GET /api/dlsite/search?title={query}&max={limit}` - æŒ‰æ ‡é¢˜æœç´¢ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰- `GET /api/dlsite/{id}` - æŒ‰IDè·å–è¯¦æƒ…ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰### å·¥å…·ç«¯ç‚¹- `GET /r/dlsite/{id}` - é‡å®šå‘åˆ°DLsiteäº§å“é¡µé¢## é…ç½®### ä¸»è¦é…ç½®é¡¹ï¼ˆappsettings.jsonï¼‰```json{  "ServiceConfig": {    "Port": 8585,    "Host": "0.0.0.0",    "AuthToken": "",    "TokenHeaderName": "X-API-Token",    "HanimeMaxConcurrentRequests": 3,    "DlsiteMaxConcurrentRequests": 3,    "HanimeRateLimitSeconds": 30,    "DlsiteRateLimitSeconds": 30,    "RequestTimeoutSeconds": 150,    "EnableAggressiveMemoryOptimization": true  }}```### é…ç½®é€‰é¡¹è¯¦è§£| é…ç½®é¡¹ | æè¿° | é»˜è®¤å€¼ | æ¨èèŒƒå›´ ||--------|------|--------|----------|| **Port** | HTTP ç›‘å¬ç«¯å£ | 8585 | 1024-65535 || **Host** | ç›‘å¬åœ°å€ | "0.0.0.0" | "127.0.0.1"ï¼ˆæœ¬åœ°ï¼‰/"0.0.0.0"ï¼ˆæ‰€æœ‰æ¥å£ï¼‰ || **AuthToken** | API è®¤è¯ä»¤ç‰Œ | ç©ºå­—ç¬¦ä¸² | å¼ºéšæœºå­—ç¬¦ä¸²ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰ || **TokenHeaderName** | è®¤è¯å¤´åç§° | "X-API-Token" | è‡ªå®šä¹‰å¤´åç§° || **HanimeMaxConcurrentRequests** | Hanime å¹¶å‘æ§½ä½ | 3 | 1-10 || **DlsiteMaxConcurrentRequests** | DLsite å¹¶å‘æ§½ä½ | 3 | 1-10 || **HanimeRateLimitSeconds** | Hanime æ¯æ§½é€Ÿç‡é™åˆ¶ | 30 | 10-60 || **DlsiteRateLimitSeconds** | DLsite æ¯æ§½é€Ÿç‡é™åˆ¶ | 30 | 10-60 || **RequestTimeoutSeconds** | è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ | 150 | 90-300 || **EnableAggressiveMemoryOptimization** | å¯ç”¨æ¿€è¿›GC | true | true/false |### å¹¶å‘æ§åˆ¶è¯´æ˜**æä¾›å•†å¹¶å‘é™åˆ¶** - ç»Ÿä¸€æ§åˆ¶å¯¹æä¾›å•†ç½‘ç«™çš„è®¿é—®ï¼š- `HanimeMaxConcurrentRequests` - é™åˆ¶å¯¹ Hanime ç½‘ç«™çš„åŒæ—¶è®¿é—®æ•°- `DlsiteMaxConcurrentRequests` - é™åˆ¶å¯¹ DLsite ç½‘ç«™çš„åŒæ—¶è®¿é—®æ•°- åŒ…æ‹¬æ‰€æœ‰æ“ä½œï¼šæœç´¢è¯·æ±‚ã€è¯¦æƒ…è·å–ã€ç›´æ¥IDæŸ¥è¯¢- è¾¾åˆ°é™åˆ¶æ—¶ï¼Œè¯·æ±‚ç­‰å¾…æœ€å¤š15ç§’ä»¥è·å–å¯ç”¨æ§½ä½- 15ç§’åä»æ— å¯ç”¨æ§½ä½åˆ™è¿”å›429çŠ¶æ€ï¼Œå‰ç«¯å°†è‡ªåŠ¨é‡è¯•### é€Ÿç‡é™åˆ¶è¯´æ˜**æ¯æ§½ç‹¬ç«‹é€Ÿç‡é™åˆ¶** - ä¸ºæ¯ä¸ªå¹¶å‘æ§½æä¾›ç‹¬ç«‹çš„é€Ÿç‡æ§åˆ¶ï¼š- `HanimeRateLimitSeconds` - æ¯ä¸ª Hanime æ§½åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶çš„æœ€å°è¯·æ±‚é—´éš”- `DlsiteRateLimitSeconds` - æ¯ä¸ª DLsite æ§½åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶çš„æœ€å°è¯·æ±‚é—´éš”- ç¼“å­˜å‘½ä¸­æ—¶ç»•è¿‡é€Ÿç‡é™åˆ¶ï¼Œç«‹å³è¿”å›- è®¾ç½®ä¸º 0 å¯ç¦ç”¨é€Ÿç‡é™åˆ¶- æ¯ä¸ªæ§½æœ‰ç‹¬ç«‹è®¡æ—¶å™¨ï¼Œä¸åŒæ§½ä¹‹é—´äº’ä¸å¹²æ‰°**é€Ÿç‡é™åˆ¶å·¥ä½œæµç¨‹ï¼š**1. è¯·æ±‚åˆ°è¾¾ â†’ æ£€æŸ¥ç¼“å­˜2. ç¼“å­˜å‘½ä¸­ â†’ ç«‹å³è¿”å›ï¼ˆæ— é€Ÿç‡é™åˆ¶ï¼‰âœ…3. ç¼“å­˜æœªå‘½ä¸­ â†’ è·å–å¹¶å‘æ§½4. æ§½è·å–æˆåŠŸ â†’ æ£€æŸ¥æ§½çš„æœ€åè¯·æ±‚æ—¶é—´5. å¦‚éœ€ç­‰å¾… â†’ ç­‰å¾…ç›´åˆ°æ»¡è¶³é€Ÿç‡é™åˆ¶é—´éš”6. ä»æä¾›å•†è·å– â†’ ç¼“å­˜å¹¶è¿”å›### ç¯å¢ƒå˜é‡è¦†ç›–ä»¥ä¸‹ç¯å¢ƒå˜é‡å¯è¦†ç›–é…ç½®æ–‡ä»¶è®¾ç½®ï¼š| ç¯å¢ƒå˜é‡ | å¯¹åº”é…ç½® | ç¤ºä¾‹ ||----------|----------|------|| **SCRAPER_PORT** | Port | `8080` || **SCRAPER_AUTH_TOKEN** | AuthToken | `your-secret-token-here` |### ç¼“å­˜é…ç½®ç¼“å­˜ç³»ç»Ÿè‡ªåŠ¨é…ç½®ï¼Œä¸»è¦å‚æ•°ï¼š- **ç¼“å­˜å®¹é‡**ï¼š100ä¸ªæ¡ç›®- **æˆåŠŸç»“æœTTL**ï¼š2åˆ†é’Ÿ- **å¤±è´¥ç»“æœTTL**ï¼š2åˆ†é’Ÿ- **é©±é€ç­–ç•¥**ï¼šLRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰**æç¤ºï¼š** æé«˜ç¼“å­˜å‘½ä¸­ç‡å¯æ˜¾è‘—æå‡å“åº”é€Ÿåº¦ï¼Œå› ä¸ºç¼“å­˜å‘½ä¸­æ—¶å®Œå…¨ç»•è¿‡é€Ÿç‡é™åˆ¶ã€‚### æ€§èƒ½è°ƒä¼˜å»ºè®®**ä½è´Ÿè½½ç¯å¢ƒï¼ˆä¸ªäººä½¿ç”¨ï¼‰ï¼š**```json{  "HanimeMaxConcurrentRequests": 3,  "DlsiteMaxConcurrentRequests": 3,  "HanimeRateLimitSeconds": 20,  "DlsiteRateLimitSeconds": 20}```**é«˜è´Ÿè½½ç¯å¢ƒï¼ˆå¤šç”¨æˆ·ï¼‰ï¼š**```json{  "HanimeMaxConcurrentRequests": 10,  "DlsiteMaxConcurrentRequests": 10,  "HanimeRateLimitSeconds": 20,  "DlsiteRateLimitSeconds": 20}```**ä¿å®ˆè®¾ç½®ï¼ˆé¿å…å°ç¦ï¼‰ï¼š**```json{  "HanimeMaxConcurrentRequests": 1,  "DlsiteMaxConcurrentRequests": 1,  "HanimeRateLimitSeconds": 60,  "DlsiteRateLimitSeconds": 60}```**ç¦ç”¨é€Ÿç‡é™åˆ¶ï¼ˆä»…ä¾èµ–å¹¶å‘æ§åˆ¶ï¼‰ï¼š**```json{  "HanimeMaxConcurrentRequests": 3,  "DlsiteMaxConcurrentRequests": 3,  "HanimeRateLimitSeconds": 0,  "DlsiteRateLimitSeconds": 0}```### è¶…æ—¶é…ç½®å»ºè®®**RequestTimeoutSeconds è®¡ç®—å…¬å¼ï¼š**```RequestTimeoutSeconds >= æ§½ç­‰å¾…æ—¶é—´(15s) + é€Ÿç‡é™åˆ¶æ—¶é—´(30s) + åˆ®å‰Šæ—¶é—´(60s) + ç¼“å†²æ—¶é—´(45s)æ¨èå€¼ï¼š150ç§’```## éƒ¨ç½²### å¼€å‘ç¯å¢ƒ```bashcd ScraperBackendServicedotnet run```### ç”Ÿäº§ç¯å¢ƒ```bashcd ScraperBackendServicedotnet publish -c Release -o ./publishcd publishdotnet ScraperBackendService.dll```### Docker```bashdocker build -t hanimeta-scraper-backend .docker run -p 8585:8585 hanimeta-scraper-backend```## ç›‘æ§å’Œè¯Šæ–­### å¥åº·æ£€æŸ¥```bashcurl http://localhost:8585/health```### ç¼“å­˜ç»Ÿè®¡```bashcurl http://localhost:8585/cache/stats```### æ¸…ç©ºç¼“å­˜```bashcurl -X DELETE http://localhost:8585/cache/clear```## æ•…éšœæ’é™¤### å¸¸è§é—®é¢˜**503 Service Unavailable**- æ£€æŸ¥å¹¶å‘æ§½ä½é…ç½®- å¢åŠ  `MaxConcurrentRequests` å€¼**è¯·æ±‚è¶…æ—¶**- å¢åŠ  `RequestTimeoutSeconds` å€¼- æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§**é¢‘ç¹429é”™è¯¯**- å‡å°‘ `RateLimitSeconds` å€¼- å¢åŠ å¹¶å‘æ§½ä½æ•°**å†…å­˜ä½¿ç”¨è¿‡é«˜**- å¯ç”¨ `EnableAggressiveMemoryOptimization`- å‡å°ç¼“å­˜å¤§å°### æ—¥å¿—çº§åˆ«åœ¨ `appsettings.json` ä¸­è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼š```json{  "Logging": {    "LogLevel": {      "Default": "Information",      "ScraperBackendService": "Debug"    }  }}```## æŠ€æœ¯æ ˆ- **.NET 8** - ç°ä»£C#è¿è¡Œæ—¶ï¼Œæ€§èƒ½æ”¹è¿›- **ASP.NET Core** - Web APIæ¡†æ¶ï¼Œä¾èµ–æ³¨å…¥- **Playwright** - æ— å¤´æµè§ˆå™¨è‡ªåŠ¨åŒ–ï¼ŒåŠ¨æ€å†…å®¹å¤„ç†- **HtmlAgilityPack** - å¿«é€ŸHTMLè§£æå’ŒDOMå¯¼èˆª- **System.Text.Json** - é«˜æ€§èƒ½JSONåºåˆ—åŒ–## å®‰å…¨æ³¨æ„äº‹é¡¹### ç”Ÿäº§éƒ¨ç½²1. **è®¾ç½®å¼ºè®¤è¯ä»¤ç‰Œ**ï¼š`AuthToken` å¿…é¡»æ˜¯å¼ºéšæœºå­—ç¬¦ä¸²2. **é™åˆ¶ç½‘ç»œè®¿é—®**ï¼šä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®IP3. **ä½¿ç”¨HTTPS**ï¼šé…ç½®åå‘ä»£ç†ï¼ˆå¦‚Nginxï¼‰æä¾›HTTPS4. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥å¼‚å¸¸è®¿é—®æ¨¡å¼### ç¤ºä¾‹Nginxé…ç½®```nginxserver {    listen 443 ssl;    server_name your-domain.com;        ssl_certificate /path/to/cert.pem;    ssl_certificate_key /path/to/key.pem;        location / {        proxy_pass http://127.0.0.1:8585;        proxy_set_header Host $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_set_header X-Forwarded-Proto $scheme;    }}```---**HanimetaScraper åç«¯æœåŠ¡** - ä¸º Jellyfin å…ƒæ•°æ®åˆ®å‰Šæä¾›å¯é çš„APIæœåŠ¡ ğŸš€