# HanimetaScraper

åŸºäº .NET 8 çš„ Jellyfin å…ƒæ•°æ®åˆ®å‰Šè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒ Hanime å’Œ DLsite å†…å®¹ï¼Œå…·å¤‡é«˜çº§é€Ÿç‡é™åˆ¶å’Œåæ£€æµ‹åŠŸèƒ½ã€‚

## é¡¹ç›®ç»“æ„

### åç«¯æœåŠ¡
- **ScraperBackendService** - æ ¸å¿ƒåˆ®å‰Šåç«¯æœåŠ¡ï¼Œæä¾›å¸¦é€Ÿç‡é™åˆ¶å’Œç¼“å­˜çš„ REST API

### Jellyfin æ’ä»¶
- **Jellyfin.Plugin.Hanimeta.HanimeScraper** - Hanime å…ƒæ•°æ®æä¾›æ’ä»¶
- **Jellyfin.Plugin.Hanimeta.DLsiteScraper** - DLsite å…ƒæ•°æ®æä¾›æ’ä»¶
- **Jellyfin.Plugin.Hanimeta.Common** - æ’ä»¶å…±äº«åº“

### æµ‹è¯•å·¥å…·
- **NewScraperTest** - åç«¯æœåŠ¡æµ‹è¯•å¥—ä»¶

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- ğŸ” **æ™ºèƒ½æœç´¢** - æŒ‰æ ‡é¢˜æˆ– ID æœç´¢å†…å®¹
- ğŸ“Š **ä¸°å¯Œå…ƒæ•°æ®** - æ ‡é¢˜ã€æè¿°ã€è¯„åˆ†ã€å‘å¸ƒæ—¥æœŸã€äººå‘˜ä¿¡æ¯
- ğŸ–¼ï¸ **å›¾åƒæ”¯æŒ** - å°é¢ã€èƒŒæ™¯ã€ç¼©ç•¥å›¾
- ğŸŒ **å¤šè¯­è¨€** - æ”¯æŒä¸­æ–‡ã€æ—¥æ–‡å†…å®¹
- âš¡ **é«˜æ€§èƒ½** - å¹¶å‘å¤„ç†ã€æ™ºèƒ½ç¼“å­˜ã€é‡è¯•æœºåˆ¶

### é«˜çº§åŠŸèƒ½
- ğŸ›¡ï¸ **åæ£€æµ‹** - å¤„ç† Cloudflare ç­‰åçˆ¬è™«æœºåˆ¶
- â±ï¸ **é€Ÿç‡é™åˆ¶** - æ¯æ§½ä½é€Ÿç‡é™åˆ¶ï¼Œé˜²æ­¢ IP å°ç¦
- ğŸ”„ **è¯·æ±‚é˜Ÿåˆ—** - ç­‰å¾…å¯ç”¨æ§½ä½è€Œéç«‹å³å¤±è´¥
- ğŸ’¾ **æ™ºèƒ½ç¼“å­˜** - å†…å­˜ç¼“å­˜é…åˆ LRU æ·˜æ±°ç­–ç•¥
- ğŸ“ **ç»“æ„åŒ–æ—¥å¿—** - å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒå¤šçº§è¯¦ç»†åº¦
- âš™ï¸ **çµæ´»é…ç½®** - ç²¾ç»†æ§åˆ¶å¹¶å‘å’Œé€Ÿç‡é™åˆ¶

## æ¶æ„

```
Jellyfin æ’ä»¶ â†’ HTTP API (3åˆ†é’Ÿè¶…æ—¶) â†’ ScraperBackendService (150ç§’è¶…æ—¶) â†’ ç½‘ç«™çˆ¬è™«
                                                      â†“
                                          å¹¶å‘æ§åˆ¶ (3ä¸ªæ§½ä½)
                                                      â†“
                                          é€Ÿç‡é™åˆ¶ (æ¯æ§½30ç§’)
                                                      â†“
                                          æä¾›å•†è®¿é—® (Hanime/DLsite)
```

åç«¯æœåŠ¡æä¾›ç»Ÿä¸€ APIï¼ŒåŒ…å«:
- **å¹¶å‘æ§åˆ¶**: é™åˆ¶æ¯ä¸ªæä¾›å•†çš„åŒæ—¶è¯·æ±‚æ•°
- **é€Ÿç‡é™åˆ¶**: å¼ºåˆ¶åŒä¸€æ§½ä½çš„è¯·æ±‚é—´éš”æ—¶é—´
- **æ™ºèƒ½ç¼“å­˜**: å‡å°‘é‡å¤è¯·æ±‚
- **è¯·æ±‚é˜Ÿåˆ—**: æœ€å¤šç­‰å¾… 15 ç§’ä»¥è·å–å¯ç”¨æ§½ä½

## å¿«é€Ÿå¼€å§‹

### 1. åç«¯æœåŠ¡è®¾ç½®

```bash
cd ScraperBackendService
dotnet run
```

æœåŠ¡å°†åœ¨ `http://0.0.0.0:8585` å¯åŠ¨

### 2. æ’ä»¶å®‰è£…

1. å¤åˆ¶æ’ä»¶ DLL åˆ° Jellyfin æ’ä»¶ç›®å½•:
   - Hanime: `Jellyfin.Plugin.Hanimeta.HanimeScraper.dll`
   - DLsite: `Jellyfin.Plugin.Hanimeta.DLsiteScraper.dll`
   - Common: `Jellyfin.Plugin.Hanimeta.Common.dll`

2. é‡å¯ Jellyfin

3. åœ¨æ’ä»¶è®¾ç½®ä¸­é…ç½®åç«¯ URL:
   - **ç®¡ç†é¢æ¿ â†’ æ’ä»¶ â†’ [æ’ä»¶åç§°] â†’ è®¾ç½®**
   - è®¾ç½® **åç«¯æœåŠ¡åœ°å€**: `http://127.0.0.1:8585` (æˆ–ä½ çš„æœåŠ¡å™¨ IP)

### 3. ä½¿ç”¨

åœ¨ Jellyfin ä¸­æ‰«æåª’ä½“åº“ï¼Œæ’ä»¶å°†è‡ªåŠ¨ä»åç«¯æœåŠ¡è·å–å…ƒæ•°æ®ã€‚

## é…ç½®

### åç«¯æœåŠ¡é…ç½®

ä¸»è¦é…ç½®é¡¹ï¼ˆappsettings.jsonï¼‰ï¼š

```json
{
  "ServiceConfig": {
    "Port": 8585,
    "Host": "0.0.0.0",
    "AuthToken": "",
    "HanimeMaxConcurrentRequests": 3,
    "DlsiteMaxConcurrentRequests": 3,
    "HanimeRateLimitSeconds": 30,
    "DlsiteRateLimitSeconds": 30,
    "RequestTimeoutSeconds": 150
  }
}
```

**é…ç½®è¯´æ˜:**

| é…ç½®é¡¹ | æè¿° | é»˜è®¤å€¼ | æ¨èèŒƒå›´ |
|--------|------|--------|----------|
| **Port** | HTTP ç›‘å¬ç«¯å£ | 8585 | 1024-65535 |
| **Host** | ç›‘å¬åœ°å€ | "0.0.0.0" | "127.0.0.1" (æœ¬åœ°) / "0.0.0.0" (å…¨éƒ¨) |
| **AuthToken** | API è®¤è¯ä»¤ç‰Œ | ç©º | å¼ºéšæœºå­—ç¬¦ä¸² |
| **HanimeMaxConcurrentRequests** | Hanime å¹¶å‘æ§½ä½æ•° | 3 | 1-10 |
| **DlsiteMaxConcurrentRequests** | DLsite å¹¶å‘æ§½ä½æ•° | 3 | 1-10 |
| **HanimeRateLimitSeconds** | Hanime é€Ÿç‡é™åˆ¶ (æ¯æ§½) | 20 | 10-60 |
| **DlsiteRateLimitSeconds** | DLsite é€Ÿç‡é™åˆ¶ (æ¯æ§½) | 20 | 10-60 |
| **RequestTimeoutSeconds** | è¯·æ±‚è¶…æ—¶ | 150 | 90-300 |

**é€Ÿç‡é™åˆ¶è¯´æ˜:**

- **å¹¶å‘æ§½ä½**: é™åˆ¶å¯åŒæ—¶æ‰§è¡Œçš„è¯·æ±‚æ•°é‡
- **é€Ÿç‡é™åˆ¶**: å¼ºåˆ¶åŒä¸€æ§½ä½è¿ç»­è¯·æ±‚çš„æœ€å°é—´éš”
- **è¯·æ±‚é˜Ÿåˆ—**: è¯·æ±‚æœ€å¤šç­‰å¾… 15 ç§’ä»¥è·å–æ§½ä½ï¼Œå¦åˆ™è¿”å› 429

**é…ç½®åœºæ™¯ç¤ºä¾‹:**

| åœºæ™¯ | æ§½ä½æ•° | é€Ÿç‡é™åˆ¶ | è¡Œä¸º |
|------|--------|----------|------|
| **æ¿€è¿›** | 10 | 10ç§’ | å¿«é€Ÿä½†æœ‰é£é™© (å¯èƒ½è§¦å‘å°ç¦) |
| **å¹³è¡¡** | 3 | 30ç§’ | è‰¯å¥½å¹³è¡¡ (æ¨è) |
| **ä¿å®ˆ** | 1 | 60ç§’ | æœ€æ…¢ä½†æœ€å®‰å…¨ |

### æ’ä»¶é…ç½®é€‰é¡¹

æ¯ä¸ªæ’ä»¶æ”¯æŒä»¥ä¸‹é…ç½®é¡¹ï¼š

| é…ç½®é¡¹ | æè¿° | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|--------|------|--------|------|
| **åç«¯æœåŠ¡åœ°å€** | ScraperBackendService çš„ URL | `http://127.0.0.1:8585` | `https://scraper.mydomain.com` |
| **API Token** | åç«¯æœåŠ¡è®¤è¯ä»¤ç‰Œï¼ˆå¯é€‰ï¼‰ | ç©º | `your-secret-token-123` |
| **å¯ç”¨æ—¥å¿—** | æ’ä»¶è°ƒè¯•æ—¥å¿—æ§åˆ¶ | `false` | `true`ï¼ˆè°ƒè¯•æ—¶ä½¿ç”¨ï¼‰ |
| **æ ‡ç­¾æ˜ å°„æ¨¡å¼** | æ ‡ç­¾å†™å…¥ä½ç½®é€‰æ‹© | `Tags` | `Tags` æˆ– `Genres` |

**æ ‡ç­¾æ˜ å°„æ¨¡å¼è¯´æ˜ï¼š**
- **Tags æ¨¡å¼**ï¼šSeries + Content Tags â†’ Jellyfin Tags å­—æ®µï¼Œåç«¯ Genres â†’ Jellyfin Genres å­—æ®µ
- **Genres æ¨¡å¼**ï¼šSeries + Content Tags â†’ Jellyfin Genres å­—æ®µï¼ˆä¸åç«¯ Genres åˆå¹¶ï¼‰

é…ç½®è·¯å¾„ï¼š**ç®¡ç†é¢æ¿ â†’ æ’ä»¶ â†’ [æ’ä»¶åç§°] â†’ è®¾ç½®**

## æ€§èƒ½è°ƒä¼˜

### å“åº”æ—¶é—´ä¼˜åŒ–

**æœ€ä½³æƒ…å†µ** (ç¼“å­˜å‘½ä¸­):
```
è¯·æ±‚ â†’ ç¼“å­˜å‘½ä¸­ â†’ å“åº”
è€—æ—¶: ~1ms âœ…
```

**æ­£å¸¸æƒ…å†µ** (é€Ÿç‡é™åˆ¶):
```
è¯·æ±‚ â†’ ç­‰å¾…æ§½ä½ â†’ é€Ÿç‡é™åˆ¶ç­‰å¾… â†’ åˆ®å‰Š â†’ ç¼“å­˜ â†’ å“åº”
è€—æ—¶: ~35-60ç§’ â±ï¸
```

**æœ€åæƒ…å†µ** (å…¨éƒ¨ç­‰å¾…):
```
è¯·æ±‚ â†’ ç­‰å¾…æ§½ä½15ç§’ â†’ é€Ÿç‡é™åˆ¶30ç§’ â†’ åˆ®å‰Š60ç§’ â†’ å“åº”
è€—æ—¶: ~105ç§’ ğŸŒ
```

### é…ç½®å»ºè®®

**ä¸ªäººä½¿ç”¨** (ä½æµé‡):
```json
{
  "HanimeMaxConcurrentRequests": 3,
  "HanimeRateLimitSeconds": 20
}
```

**å¤šç”¨æˆ·** (é«˜æµé‡):
```json
{
  "HanimeMaxConcurrentRequests": 5,
  "HanimeRateLimitSeconds": 30
}
```

**ä¿å®ˆé…ç½®** (é¿å…å°ç¦):
```json
{
  "HanimeMaxConcurrentRequests": 1,
  "HanimeRateLimitSeconds": 60
}
```

### ç¦ç”¨é€Ÿç‡é™åˆ¶ (ä¸æ¨è)

å¦‚éœ€ç¦ç”¨é€Ÿç‡é™åˆ¶ (ç”¨äºæµ‹è¯•æˆ–ç§æœ‰å®ä¾‹):

```json
{
  "HanimeRateLimitSeconds": 0,
  "DlsiteRateLimitSeconds": 0
}
```

âš ï¸ **è­¦å‘Š**: ç¦ç”¨é€Ÿç‡é™åˆ¶å¯èƒ½å¯¼è‡´ç›®æ ‡ç½‘ç«™å°ç¦ IPã€‚

## æ—¥å¿—ç³»ç»Ÿ

åç«¯æœåŠ¡æä¾›ç»“æ„åŒ–æ—¥å¿—ï¼Œæ”¯æŒå¤šçº§è¯¦ç»†åº¦:

**æ€»æ˜¯å¯è§ (LogAlways):**
- ç”¨æˆ·æ“ä½œ (æœç´¢/æŸ¥è¯¢å¼€å§‹)
- æ“ä½œç»“æœ (æˆåŠŸ/å¤±è´¥/ç»“æœæ•°)
- é€Ÿç‡é™åˆ¶ç­‰å¾…
- æœåŠ¡çŠ¶æ€

**ä¿¡æ¯çº§åˆ« (LogInformation):**
- ç¼“å­˜æ“ä½œ
- å†…éƒ¨æµç¨‹çŠ¶æ€

**è°ƒè¯•çº§åˆ« (LogDebug):**
- æ§½ä½åˆ†é…è¯¦æƒ…
- å†…å­˜ç®¡ç†
- æ€§èƒ½æŒ‡æ ‡

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹:**

```
12:34:56 [HanimeDetail] Query: '12345'
12:34:57 [HanimeDetail] Waiting 25s (rate limit)
12:35:22 [HanimeDetail] âœ… Found
```

## API ç«¯ç‚¹

### åŸºç¡€
- `GET /` - æœåŠ¡ä¿¡æ¯
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /cache/stats` - ç¼“å­˜ç»Ÿè®¡
- `DELETE /cache/clear` - æ¸…ç©ºç¼“å­˜
- `DELETE /cache/{provider}/{id}` - åˆ é™¤ç‰¹å®šç¼“å­˜

### Hanime
- `GET /api/hanime/search?title={query}&max={limit}` - æ ‡é¢˜æœç´¢
- `GET /api/hanime/{id}` - ID æŸ¥è¯¢è¯¦æƒ…

### DLsite  
- `GET /api/dlsite/search?title={query}&max={limit}` - æ ‡é¢˜æœç´¢
- `GET /api/dlsite/{id}` - ID æŸ¥è¯¢è¯¦æƒ…

## æ•…éšœæ’é™¤

### å“åº”æ—¶é—´è¿‡é•¿

**ç—‡çŠ¶:** è¯·æ±‚éœ€è¦ 60+ ç§’

**è§£å†³æ–¹æ¡ˆ:**
1. æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡: `GET /cache/stats`
2. å‡å°‘é€Ÿç‡é™åˆ¶: `HanimeRateLimitSeconds: 15`
3. å¢åŠ å¹¶å‘æ§½ä½: `HanimeMaxConcurrentRequests: 5`

### é¢‘ç¹ 429 é”™è¯¯

**ç—‡çŠ¶:** å¤§é‡ "Service busy" æ¶ˆæ¯

**è§£å†³æ–¹æ¡ˆ:**
1. å¢åŠ å¹¶å‘æ§½ä½: `HanimeMaxConcurrentRequests: 5`
2. å¢åŠ åç«¯è¶…æ—¶: `RequestTimeoutSeconds: 180`

### IP è¢«å°ç¦

**ç—‡çŠ¶:** è¯·æ±‚å¤±è´¥ï¼Œå‡ºç° Cloudflare æŒ‘æˆ˜

**è§£å†³æ–¹æ¡ˆ:**
1. å¢åŠ é€Ÿç‡é™åˆ¶: `HanimeRateLimitSeconds: 45`
2. å‡å°‘å¹¶å‘æ§½ä½: `HanimeMaxConcurrentRequests: 2`
3. å¯ç”¨æ¿€è¿›å†…å­˜ä¼˜åŒ–

## æ–‡æ¡£

- **åç«¯ README**: [ScraperBackendService/README.md](ScraperBackendService/README.md)

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®! è¯·éšæ—¶æäº¤ Pull Requestã€‚

## æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–åŠŸèƒ½è¯·æ±‚ï¼Œè¯·ä½¿ç”¨ [GitHub Issues](https://github.com/Qing-98/HanimetaScraper/issues) é¡µé¢ã€‚