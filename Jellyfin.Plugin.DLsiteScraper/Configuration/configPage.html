<div id="DLsiteConfigurationPage" data-role="page" class="page type-interior pluginConfigurationPage" data-title="DLsite Scraper" data-require="emby-input,emby-button,emby-checkbox">
    <div data-role="content">
        <div class="content-primary">
            <form id="DLsiteScraperConfigForm" onsubmit="return false;">
                <div class="inputContainer">
                    <input is="emby-input" type="text" id="txtBackendUrl" label="Backend URL:" />
                    <div class="fieldDescription">URL of the scraper backend service (e.g. http://127.0.0.1:8585)</div>
                </div>
                <div class="inputContainer">
                    <input is="emby-input" type="text" id="txtApiToken" label="API Token (Optional):" />
                    <div class="fieldDescription">Optional API token for authentication with the backend service</div>
                </div>
                <div class="checkboxContainer">
                    <label>
                        <input is="emby-checkbox" type="checkbox" id="chkEnableLogging" />
                        <span>Enable Logging</span>
                    </label>
                    <div class="fieldDescription">Enable detailed logging for troubleshooting</div>
                </div>
                <br />
                <div>
                    <button id="btnSave" is="emby-button" type="button" class="raised block btnSave">
                        <span>Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    (function () {
        var pluginId = "d2e313b1-0c08-4a4b-9696-768a06561c3f";

        function load(page, config) {
            page.querySelector('#txtBackendUrl').value = config.BackendUrl || 'http://127.0.0.1:8585';
            page.querySelector('#txtApiToken').value = config.ApiToken || '';
            page.querySelector('#chkEnableLogging').checked = config.EnableLogging || false;
            Dashboard.hideLoadingMsg();
        }

        function save() {
            Dashboard.showLoadingMsg();
            var page = document.getElementById('DLsiteConfigurationPage');
            var newCfg = {
                BackendUrl: (page.querySelector('#txtBackendUrl').value || '').trim(),
                ApiToken: (page.querySelector('#txtApiToken').value || '').trim(),
                EnableLogging: page.querySelector('#chkEnableLogging').checked
            };

            ApiClient.getPluginConfiguration(pluginId)
                .then(function (current) {
                    Object.assign(current, newCfg);
                    return ApiClient.updatePluginConfiguration(pluginId, current);
                })
                .then(function (result) {
                    Dashboard.processPluginConfigurationUpdateResult(result);
                });
        }

        function getTabs() {
            return [{ href: Dashboard.getPluginUrl(pluginId), name: 'DLsite Scraper' }];
        }

        function init(page) {
            Dashboard.showLoadingMsg();
            LibraryMenu.setTabs('plugins', 0, getTabs);
            ApiClient.getPluginConfiguration(pluginId).then(function (config) { load(page, config); });
            var btn = page.querySelector('#btnSave');
            if (btn) { btn.addEventListener('click', save); }
        }

        function tryInit() {
            var page = document.getElementById('DLsiteConfigurationPage');
            if (page) { init(page); }
        }

        var pageEl = document.getElementById('DLsiteConfigurationPage');
        if (pageEl) {
            pageEl.addEventListener('pageshow', function () { init(this); });
            pageEl.addEventListener('viewshow', function () { init(this); });
        }

        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(tryInit, 0);
        } else {
            document.addEventListener('DOMContentLoaded', tryInit);
        }
    })();
</script>
